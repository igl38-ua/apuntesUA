# Resumen

- Las clases **testables** inyectan las dependencias y los **stubs** (dobles de pruebas) controlan los valores que devuelven las funciones invocadas desde la dependencia.

___
## ğŸ”¹ **Flujo de dependencias y ficheros**

El cÃ³digo presentado sigue un enfoque de pruebas unitarias en Java, separando la lÃ³gica de negocio de las dependencias externas para facilitar la inyecciÃ³n de _stubs_ durante los tests.

![item](../img/ppss/STUBS.png)

La dependencia fija es la instancia de `IService` y `buscarDatos.elemPendientes(cli)` es un mÃ©todo de la dependencia del cual necesitamos controlar su valor.

- **Se instancia la STUB**, `BuscadorSTUB`, que darÃ¡ el valor a la llamada a `buscarDatos.elemPendientes()` cuando se llame desde el test (`sut.generarFactura(cli)`).

```java
BuscadorSTUB stub = new BuscadorSTUB(10); // DevolverÃ¡ 10 cuando elemPendientes() sea llamado
```

- **Se instancia la Testable**, `GestorPedidosTestable`.

```java
GestorPedidosTestable sut = new GestorPedidosTestable();
```

- **Se inyecta el Stub en la SUT**, mediante el setter `setBuscador(stub)` se sobre escribe la instancia de `IService` en la sut (`IService buscarDatos = getBuscador();`).

```java
sut.setBuscador(stub); // Reemplaza la dependencia fija con el Stub
```

- **Se ejecuta el test**, llamando al mÃ©todo de la sut.

```java
Factura expectedResult = new Factura(...);
Factura realResult = assertDoesNotThrow(() -> sut.generarFactura(cli));

assertEquals(expectedResult, realResult);
```

___
### ğŸ“Œ **1. CÃ³digo de producciÃ³n (SUT) - `GestorPedidos.java`**

ğŸ“‚ UbicaciÃ³n: `/src/main/java`  
ğŸ“„ **Archivo**: `GestorPedidos.java`  
âœ **PropÃ³sito**:  
Este es el cÃ³digo original de la SUT (System Under Test). Tiene un mÃ©todo `generarFactura()` que usa una dependencia `IService` para obtener informaciÃ³n sobre los elementos pendientes.

```java
public class GestorPedidos {
    public IService getBuscador() {
        IService buscar = new Buscador();
        return buscar;
    }

    public Factura generarFactura(Cliente cli) throws FacturaException {
        Factura factura = new Factura();
        IService buscarDatos = getBuscador();

        int numElems = buscarDatos.elemPendientes(cli);
        if (numElems > 0) {
            // cÃ³digo para generar la factura
            factura = ...;
        } else {
            throw new FacturaException("No hay ...");
        }
        return factura;
    }
}
```

ğŸ” **Problema**:

- `getBuscador()` crea directamente una instancia de `Buscador()`, lo que hace difÃ­cil reemplazar esta dependencia con un _stub_ en las pruebas.
- No es posible controlar el comportamiento de `elemPendientes()` en un entorno de pruebas.

âœ… **SoluciÃ³n**:  
Refactorizamos `GestorPedidos` para permitir la inyecciÃ³n de dependencias, creando una subclase **`GestorPedidosTestable`**.

___
### ğŸ“Œ **2. ImplementaciÃ³n del _Stub_ - `BuscadorSTUB.java`**

ğŸ“‚ UbicaciÃ³n: `/src/test/java`  
ğŸ“„ **Archivo**: `BuscadorSTUB.java`  
âœ **PropÃ³sito**:  
Este es un _stub_ (doble de prueba) que implementa `IService`. Nos permite controlar el valor devuelto por `elemPendientes()` en los tests.

```java
public class BuscadorSTUB implements IService {
    int resultado;

    public BuscadorSTUB(int salida) {
        this.resultado = salida;
    }

    @Override
    public int elemPendientes(Cliente cli) {
        return resultado;
    }
}
```

ğŸ” **Beneficio**:

- Nos permite controlar el nÃºmero de elementos pendientes sin depender de la implementaciÃ³n real de `Buscador`.
- Evita acceder a una base de datos o sistema externo en los tests.

___
### ğŸ“Œ **3. Subclase de `GestorPedidos` para permitir inyecciÃ³n - `GestorPedidosTestable.java`**

ğŸ“‚ UbicaciÃ³n: `/src/test/java`  
ğŸ“„ **Archivo**: `GestorPedidosTestable.java`  
âœ **PropÃ³sito**:  
Esta clase hereda de `GestorPedidos` y sobrescribe `getBuscador()` para permitir la inyecciÃ³n de un _stub_ en lugar del buscador real.

```java
public class GestorPedidosTestable extends GestorPedidos {
    IService busca;

    @Override
    public IService getBuscador() {
        return busca;
    }

    public void setBuscador(IService b) {
        this.busca = b;
    }
}
```

ğŸ” **Beneficio**:

- Permite asignar un _stub_ en tiempo de prueba con `setBuscador(stub)`.
- Separa la lÃ³gica de producciÃ³n de la de prueba sin modificar `GestorPedidos`.

___
### ğŸ“Œ **4. Prueba unitaria - `GestorPedidosTest.java`**

ğŸ“‚ UbicaciÃ³n: `/src/test/java`  
ğŸ“„ **Archivo**: `GestorPedidosTest.java`  
âœ **PropÃ³sito**:  
Esta clase es el _driver_, el cÃ³digo que ejecuta la prueba unitaria.

```java
public class GestorPedidosTest {
    @Test
    public void testGenerarFactura() {
        Cliente cli = new Cliente(...);
        BuscadorSTUB stub = new BuscadorSTUB(10);
        GestorPedidosTestable sut = new GestorPedidosTestable();

        sut.setBuscador(stub);
        Factura expectedResult = new Factura(...);
        Factura realResult = assertDoesNotThrow(() -> sut.generarFactura(cli));

        assertEquals(expectedResult, realResult);
    }
}
```

ğŸ” **Beneficio**:

- Se crea un _stub_ (`BuscadorSTUB(10)`) que devuelve siempre `10` elementos pendientes.
- Se inyecta este _stub_ en `GestorPedidosTestable` usando `setBuscador(stub)`.
- La prueba valida que `generarFactura()` funciona correctamente sin depender de `Buscador`.

___
## ğŸ”¹ **Resumen del flujo de dependencias**

ğŸ“Œ **CÃ³digo de producciÃ³n (`src/main/java`)**

- `GestorPedidos.java`: Implementa la funcionalidad principal (SUT).
- Contiene una dependencia `IService`, que en producciÃ³n es `Buscador()`.

ğŸ“Œ **CÃ³digo de pruebas (`src/test/java`)**

- `BuscadorSTUB.java`: Implementa un _stub_ de `IService` para pruebas.
- `GestorPedidosTestable.java`: Clase que permite inyectar el _stub_ en lugar de `Buscador()`.
- `GestorPedidosTest.java`: Prueba unitaria que usa `GestorPedidosTestable` con un _stub_.

___
## ğŸ”¹ **ConclusiÃ³n**

âœ… Se logra desacoplar la SUT de la implementaciÃ³n real de `Buscador`.  
âœ… Se facilita la prueba de `GestorPedidos` con datos controlados.  
âœ… Se aplican principios de inyecciÃ³n de dependencias y diseÃ±o orientado a pruebas.

___
# GeneralizaciÃ³n

1. **Los STUBS** ğŸ› ï¸
    
    - Son _dobles de prueba_ que reemplazan una dependencia real en la SUT.
    - Se usan para **controlar los valores de retorno de mÃ©todos** en dependencias externas o fijas.
    - Evitan interacciones con sistemas reales como bases de datos, APIs externas, etc.
    - Permiten pruebas deterministas con valores predefinidos.

2. **Las clases Testable** ğŸ—ï¸
    
    - Se crean cuando la SUT tiene dependencias **fijas y no inyectables**.
    - Su propÃ³sito es permitir la **inyecciÃ³n de dependencias** mediante mÃ©todos como `setDependencia()`.
    - Suelen sobrescribir mÃ©todos que crean instancias de dependencias fijas, sustituyÃ©ndolas por versiones inyectables.
    - No modifican la SUT original, sino que la extienden para hacerla testeable sin cambiar su comportamiento en producciÃ³n.

âœ… **En conjunto**, los _stubs_ permiten controlar el comportamiento de dependencias y las _clases testables_ hacen posible la inyecciÃ³n de esas dependencias en la SUT para realizar pruebas unitarias de manera controlada.